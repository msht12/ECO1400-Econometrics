---
title: "ECO1400 Term Paper"
author: "Matthew Tang"
date: "2022-12-01"
output: pdf_document
---

Install and load required R packages
```{r, message=FALSE}
library(pder) # data
library(plm)  # function: plm
library(stargazer)
library(dplyr)
```

Cursory data cleaning was done in Python. Import data into R.
```{r}
# read data
#cfps = read.csv("C:/Users/mattt/OneDrive/Documents/GitHub/ECO1400-Econometrics/fulldata20162018.csv")
cfps = read.csv("C:/Users/mattt/OneDrive/Documents/GitHub/ECO1400-Econometrics/fulldata.csv")


# remove rows where a child is observed only once
cfps <- cfps %>%
                 group_by(pid) %>%
                 filter(n()>1)

# drop variable X (remnant from Python data cleaning)
#cfps = subset(cfps, select = -X )

# -------------------------------------------------------------------------

# recode variables

cfps$cid[cfps$cid == -9] <- NA # -9: missing
cfps$urban[cfps$urban == -9] <- NA # -9: missing, 1: urban, 0: rural
cfps$urban_m[cfps$urban_m == -9] <- NA # -9: missing, 1: urban, 0: rural
cfps$urban_f[cfps$urban_f == -9] <- NA # -9: missing, 1: urban, 0: rural
cfps$age[cfps$age == -1] <- NA # -1: unknown
cfps$b_feed_mon[cfps$b_feed_mon == -1] <- NA # -1: unknown
cfps$b_feed_mon[cfps$b_feed_mon == -8] <- NA # -8: not applicable (CHECK IF NOT APP MEANS NEVER BEEN BREASTFED)

cfps$board_school[cfps$board_school == -1] <- NA # -1: unknown
cfps$board_school[cfps$board_school == -8] <- NA # -8: not applicable (CHECK IF NOT APP MEANS NOT OLD ENOUGH FOR BOARDING SCHOOL)

cfps$verbal[cfps$verbal == -1] <- NA # -1: unknown
cfps$verbal[cfps$verbal == -8] <- NA # -8: not applicable (CHECK IF NOT APP MEANS CHILD NOT OLD ENOUGH FOR GRADES)

cfps$math[cfps$math == -1] <- NA # -1: unknown
cfps$math[cfps$math == -8] <- NA # -8: not applicable (CHECK IF NOT APP MEANS CHILD NOT OLD ENOUGH FOR GRADES)

cfps$school_tut_hrs[cfps$school_tut_hrs == -1] <- NA # -1: unknown
cfps$school_tut_hrs[cfps$school_tut_hrs == -8] <- 0  # -8: not applicable

cfps$comp_tut_hrs[cfps$comp_tut_hrs == -8] <- 0  # -8: not applicable

cfps$hobby_tut_hrs[cfps$hobby_tut_hrs == -1] <- NA # -1: unknown
cfps$hobby_tut_hrs[cfps$hobby_tut_hrs == -8] <- 0  # -8: not applicable

cfps$int_tut_hrs[cfps$int_tut_hrs == -1] <- NA # -1: unknown
cfps$int_tut_hrs[cfps$int_tut_hrs == -8] <- 0  # -8: not applicable

cfps$parent_child_tut_hrs[cfps$parent_child_tut_hrs == -1] <- NA # -1: unknown
cfps$parent_child_tut_hrs[cfps$parent_child_tut_hrs == -8] <- 0  # -8: not applicable

cfps$other_tut_hrs[cfps$other_tut_hrs == -1] <- NA # -1: unknown
cfps$other_tut_hrs[cfps$other_tut_hrs == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs1[cfps$fam_member_tut_hrs1 == -1] <- NA # -1: unknown
cfps$fam_member_tut_hrs1[cfps$fam_member_tut_hrs1 == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs2[cfps$fam_member_tut_hrs2 == -1] <- NA # -1: unknown
cfps$fam_member_tut_hrs2[cfps$fam_member_tut_hrs2 == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs3[cfps$fam_member_tut_hrs3 == -1] <- NA # -1: unknown
cfps$fam_member_tut_hrs3[cfps$fam_member_tut_hrs3 == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs4[cfps$fam_member_tut_hrs4 == -1] <- NA # -1: unknown
cfps$fam_member_tut_hrs4[cfps$fam_member_tut_hrs4 == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs5[cfps$fam_member_tut_hrs5 == -1] <- NA # -1: unknown
cfps$fam_member_tut_hrs5[cfps$fam_member_tut_hrs5 == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs6[cfps$fam_member_tut_hrs6 == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs7[cfps$fam_member_tut_hrs7 == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs8[cfps$fam_member_tut_hrs8 == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs9[cfps$fam_member_tut_hrs9 == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs10[cfps$fam_member_tut_hrs10 == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs11[cfps$fam_member_tut_hrs11 == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs12[cfps$fam_member_tut_hrs12 == -8] <- 0  # -8: not applicable

cfps$fam_member_tut_hrs31[cfps$fam_member_tut_hrs31 == -1] <- NA # -1: unknown
cfps$fam_member_tut_hrs31[cfps$fam_member_tut_hrs31 == -8] <- 0  # -8: not applicable

cfps$verbal[cfps$verbal == 1] <- 4   # 1: excellent
cfps$verbal[cfps$verbal == 2] <- 3   # 2: good
cfps$verbal[cfps$verbal == 3] <- 2   # 3: average
cfps$verbal[cfps$verbal == 4] <- 1   # 4: poor
cfps$verbal[cfps$verbal == -2] <- NA # -2: NA

cfps$math[cfps$math == 1] <- 4   # 1: excellent
cfps$math[cfps$math == 2] <- 3   # 2: good
cfps$math[cfps$math == 3] <- 2   # 3: average
cfps$math[cfps$math == 4] <- 1   # 4: poor
cfps$math[cfps$math == -2] <- NA # -2: NA

cfps$marital_f[cfps$marital_f == 1] <- "never married" 
cfps$marital_f[cfps$marital_f == 2] <- "married" 
cfps$marital_f[cfps$marital_f == 3] <- "cohabitation" 
cfps$marital_f[cfps$marital_f == 4] <- "divorced" 

cfps$marital_m[cfps$marital_m == -1] <- "unknown" 
cfps$marital_m[cfps$marital_m == 1] <- "never married" 
cfps$marital_m[cfps$marital_m == 2] <- "married" 
cfps$marital_m[cfps$marital_m == 3] <- "cohabitation"
cfps$marital_m[cfps$marital_m == 4] <- "divorced"

cfps$year_divorced_m[cfps$year_divorced_m == -8] <- NA

cfps$year_divorced_f[cfps$year_divorced_f == -1] <- NA 
cfps$year_divorced_f[cfps$year_divorced_f == -8] <- NA 

cfps$salary_f[cfps$salary_f == -9] <- NA # -1: unknown
cfps$salary_f[cfps$salary_f == -8] <- NA # -2: refuse
cfps$salary_f[cfps$salary_f == -2] <- NA # -8: not applicable
cfps$salary_f[cfps$salary_f == -1] <- NA # -9: missing

cfps$salary_m[cfps$salary_m == -9] <- NA # -1: unknown
cfps$salary_m[cfps$salary_m == -8] <- NA # -2: refuse
cfps$salary_m[cfps$salary_m == -2] <- NA # -8: not applicable
cfps$salary_m[cfps$salary_m == -1] <- NA # -9: missing

# -------------------------------------------------------------------------

# Define new variables
cfps$total_paid_tut_hrs = cfps$school_tut_hrs + cfps$comp_tut_hrs + cfps$hobby_tut_hrs
                     + cfps$int_tut_hrs + cfps$parent_child_tut_hrs + cfps$other_tut_hrs

cfps$total_fam_tut_hrs = cfps$fam_member_tut_hrs1 + cfps$fam_member_tut_hrs2 + 
  cfps$fam_member_tut_hrs3  + cfps$fam_member_tut_hrs4  + cfps$fam_member_tut_hrs5 


# create dummy vars that identify whether parent is divorced (1) or otherwise (0)
cfps$divorced_dummy_f = ifelse(cfps$marital_f == "divorced" 
                               & (!is.na(cfps$marital_f)), 
                               1, 0)

cfps$divorced_dummy_m = ifelse(cfps$marital_m == "divorced" 
                               & (!is.na(cfps$marital_m)),
                               1, 0)

# create dummy var that identifies if child has at least 1 divorced parent
cfps$divorced_dummy = ifelse(cfps$marital_m == "divorced" | cfps$marital_f == "divorced", 1, 0)

# total salary of both parents combined
cfps$total_salary = cfps$salary_f  + cfps$salary_m

# create dataset with only complete observations
#cfps_no_verbal <- cfps[is.na(cfps$verbal),]
cfps_final <- cfps[!is.na(cfps$verbal),]                             # remove rows with NAs in verbal
cfps_final <- cfps_final[!is.na(cfps_final$math),]                   # remove rows with NAs in math
cfps_final <- cfps_final[!is.na(cfps_final$divorced_dummy_f),]       # remove rows with NAs in divorced_dummy_f
cfps_final <- cfps_final[!is.na(cfps_final$divorced_dummy_m),]       # remove rows with NAs in divorced_dummy_m
cfps_final <- cfps_final[!is.na(cfps_final$salary_f),]               # remove rows with NAs in salary_f
cfps_final <- cfps_final[!is.na(cfps_final$salary_m),]               # remove rows with NAs in salary_m
cfps_final <- cfps_final[!is.na(cfps_final$urban),]                  # remove rows with NAs in urban
cfps_final <- cfps_final[!is.na(cfps_final$urban_f),]                # remove rows with NAs in urban_f
cfps_final <- cfps_final[!is.na(cfps_final$urban_m),]                # remove rows with NAs in urban_m
cfps_final <- cfps_final[!is.na(cfps_final$board_school),]           # remove rows with NAs in board_school
cfps_final <- cfps_final[!is.na(cfps_final$total_fam_tut_hrs),]      # remove rows with NAs in total_fam_tut_hrs
```



```{r}
# Use the following covariates: divorce dummy, employment status, urban dummy, 
# CCP, parent education, 

ols1 = lm(math ~ salary_m + salary_f + urban + urban_m + urban_f
           + board_school + divorced_dummy_f + divorced_dummy_m + total_fam_tut_hrs,
           data=cfps_final)

ols2 = plm(math ~ salary_m + salary_f + urban + urban_m + urban_f
           + board_school + divorced_dummy_f + divorced_dummy_m + total_fam_tut_hrs,
           data=cfps_final, index=c("pid", "intyear"),
           model="pooling", effect="twoways")

FE_no_lag <- plm(math ~ salary_m + salary_f + urban + urban_m + urban_f
           + board_school + divorced_dummy_f + divorced_dummy_m + total_fam_tut_hrs,
          data = cfps_final, index=c("pid", "intyear"),
           model="within", effect="twoways")

FE_lag <- plm(math ~ lag(math) + salary_m + salary_f + urban + urban_m + urban_f
           + board_school + divorced_dummy_f + divorced_dummy_m + total_fam_tut_hrs,
          data = cfps_final, index=c("pid", "intyear"),
           model="within", effect="twoways")

test1 = lm(math ~ lag(math) + salary_m + salary_f + urban + urban_m + urban_f
           + board_school + divorced_dummy_f + divorced_dummy_m + total_fam_tut_hrs,
          data = cfps_final)


# use simplified variables (total salary instead of salary_m, salary_f;
#                           divorced_dummy instead of divorced_dummy_m, divorced_dummy_f)

ols1_red = lm(math ~ total_salary + urban + urban_m + urban_f
           + board_school + divorced_dummy + total_fam_tut_hrs,
           data=cfps_final)

ols2_red = plm(math ~ total_salary + urban + urban_m + urban_f
           + board_school + divorced_dummy + total_fam_tut_hrs,
           data=cfps_final, index=c("pid", "intyear"),
           model="pooling", effect="time")

FE_no_lag_red <- plm(math ~ total_salary + urban
           + board_school + divorced_dummy + total_fam_tut_hrs,
          data = cfps_final, index=c("pid", "intyear"),
           model="within", effect="twoways")

FE_no_lag_red <- plm(math ~ lag(math) + total_salary + urban
           + board_school + divorced_dummy + total_fam_tut_hrs,
          data = cfps_final, index=c("pid", "intyear"),
           model="within", effect="time")

test2 = lm(math ~ lag(math) + total_salary + urban
           + board_school + divorced_dummy + total_fam_tut_hrs,
          data = cfps_final)

```


Fixed Effects
```{r}
FE <- plm(democracy ~ lag(democracy) + lag(income),
           data=cfps, index=c("country", "year"),
           model="within", effect="twoways")
coef(summary(FE))[1:2,]
```
Note the change in the democracy coefficient and lack of significance of income.

Arellano-Bond one-step estimator.
The formula has three parts: the first contains the explanatory variables and the second the “gmm” instruments (history of lags of y). The option effect="twoways" adds year dummy variables into the model. The lag subscript on the "gmm" instrument, 2:99, is longer than the time dimension of the data, but any extra length of the vector past actual data is simply ignored by R. This is useful especially for unbalanced panels with different histories for different individuals.
```{r}
diff1 <- pgmm(democracy ~ lag(democracy) + lag(income) | lag(democracy, 2:99),
              data=cfps, index=c("country", "year"),
              model="onestep", effect="twoways")
coef(summary(diff1))[1:2,]
```

Arellano-Bond two-step estimator
```{r}
diff2 <- pgmm(democracy ~ lag(democracy) + lag(income) | lag(democracy, 2:99),
              data=cfps, index=c("country", "year"),
              model="twosteps", effect="twoways")
coef(summary(diff2))[1:2,]
```

System GMM estimator. The change from Arellano-Bond is that the argument "transformation", which defaults to "d" for difference, must be set to "ld" (for level and difference).
```{r}
sys2 <- pgmm(democracy ~ lag(democracy) + lag(income) |
             lag(democracy, 2:99),
             data=cfps, index=c("country", "year"),
             model="twosteps", effect="twoways",
             transformation = "ld")
coef(summary(sys2))[1:2,]
```

Output results in LaTeX in table format
```{r warning=FALSE}
stargazer(diff1, diff2, sys2, title="Dynamic Panel Data", 
          column.labels=c("AB one step", "AB two steps", "System GMM"), 
          no.space = TRUE, omit.stat=c("f", "ser"))
```